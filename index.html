<div id="debug-console" style="background: #333; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; margin-top: 20px; border-radius: 5px;">
    <strong>Debug Log:</strong><br>
</div>

<script>
    // --- 1. SETUP VISUAL LOGGING (So you can see errors on mobile) ---
    function logToScreen(message, isError = false) {
        const consoleDiv = document.getElementById('debug-console');
        const line = document.createElement('div');
        line.style.color = isError ? '#ff4444' : '#0f0';
        line.style.borderBottom = '1px solid #444';
        line.style.padding = '4px 0';
        line.textContent = (isError ? '[ERROR] ' : '[INFO] ') + message;
        consoleDiv.appendChild(line);
    }
    
    // Capture standard errors
    window.onerror = function(msg, url, line) {
        logToScreen(`${msg} (Line ${line})`, true);
    };

    // --- 2. CHART CODE ---
    
   
    const sheetId = '1FsL3YWzuyp3tQxeBhGzUAw0_Jn9sx5F4qyzPNojh-nM'; 
    const rawUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
    
    // We use a proxy to bypass CORS restrictions on mobile/web
    const csvUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(rawUrl);

    logToScreen("Attempting to fetch data from: " + csvUrl);

    Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            logToScreen(`Download complete! Found ${results.data.length} rows.`);
            
            if (results.data.length === 0) {
                logToScreen("Error: Data is empty. Check your Sheet permissions (Anyone with link?).", true);
                return;
            }

            try {
                renderChart(results.data);
                logToScreen("Chart rendered successfully!");
            } catch (e) {
                logToScreen("Render Error: " + e.message, true);
            }
        },
        error: function(err) {
            logToScreen("CSV Parse Error: " + err.message, true);
        }
    });

    function renderChart(data) {
        // Validation: Ensure ID 1 exists
        const root = data.find(d => d.id == '1');
        if (!root) {
             throw new Error("Row with ID 1 not found. Check CSV content.");
        }

        chart = new d3.OrgChart()
            .container('#chart-container')
            .data(data)
            .nodeHeight(d => 100)
            .nodeWidth(d => 220)
            .childrenMargin(d => 50)
            .compactMarginBetween(d => 25)
            .compactMarginPair(d => 50)
            .nodeContent(function (d) {
                return `
                    <div class="node-box">
                        <div class="node-header">
                            ${d.data.department}
                            <div class="node-stats">
                                (Total: ${d.data.total || 0} / Reg: ${d.data.regular || 0})
                            </div>
                        </div>
                        <div class="node-content">
                            ${d.data.manager} <span style="color:#666">(${d.data.rank})</span>
                        </div>
                    </div>
                `;
            })
            .render();
            
        chart.fit(); // Auto-zoom to fit screen
    }

    function downloadPdf() {
        if(!chart) return;
        chart.exportImg({
            save: false,
            full: true,
            onLoad: (base64) => {
                var pdf = new jspdf.jsPDF({
                    orientation: "landscape",
                    unit: "px",
                    format: [chart.svgWidth(), chart.svgHeight()]
                });
                pdf.addImage(base64, 'JPEG', 0, 0);
                pdf.save('Company_Chart.pdf');
            }
        });
    }
</script>
