<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Org Chart (Smart Fix)</title>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-org-chart@2.6.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f8; margin: 0; padding: 10px; }
        /* Debug Console */
        #debug-console {
            background: #222; color: #0f0; padding: 10px; 
            font-family: monospace; font-size: 11px; margin-bottom: 20px; 
            border-radius: 5px; height: 120px; overflow-y: scroll;
            border: 2px solid #555;
        }
        /* Chart Controls */
        .controls { text-align: center; margin-bottom: 10px; }
        button {
            padding: 10px 15px; background-color: #333; color: white; 
            border: none; border-radius: 4px; font-size: 14px; margin: 5px; cursor:pointer;
        }
        button:active { background-color: #555; }
        
        /* Chart Design */
        #chart-container { height: 600px; background-color: white; border-radius: 8px; border: 1px solid #ddd; }
        .node-box { height:100%; background:#fff; border:1px solid #999; display:flex; flex-direction:column; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .node-header { background:#e0e0e0; padding:5px; text-align:center; border-bottom:1px solid #ccc; }
        .node-content { padding:10px; text-align:center; flex-grow:1; }
    </style>
</head>
<body>

    <div id="debug-console"><strong>System Status:</strong> Initializing Smart Fix...<br></div>

    <div class="controls">
        <button onclick="downloadPdf()">Download PDF</button>
        <button onclick="if(chart) chart.fit()">Fit Screen</button>
    </div>

    <div id="chart-container"></div>

    <script>
        // --- 1. SETTINGS ---
        const sheetId = '1FsL3YWzuyp3tQxeBhGzUAw0_Jn9sx5F4qyzPNojh-nM'; 
        
        // --- 2. LOGGING ---
        function log(msg, isError = false) {
            const c = document.getElementById('debug-console');
            if(c) {
                c.innerHTML += `<div style="color:${isError ? '#ff4444' : '#00ff00'}; border-bottom:1px solid #333;">${isError ? '[ERR]' : '[OK]'} ${msg}</div>`;
                c.scrollTop = c.scrollHeight;
            }
        }

        // --- 3. MAIN LOGIC ---
        const rawUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
        // Use AllOrigins proxy to bypass mobile security blocks
        const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(rawUrl);

        log("Fetching data from Google Sheet...");

        Papa.parse(proxyUrl, {
            download: true,
            header: true, 
            skipEmptyLines: true,
            complete: function(results) {
                processData(results.data);
            },
            error: function(err) {
                log("Network Error: " + err.message, true);
            }
        });

        function processData(data) {
            let cleanData = data;

            // FIX 1: Detect if pasted into one column
            if (cleanData.length > 0 && Object.keys(cleanData[0]).length === 1) {
                log("Detected single-column paste. Splitting columns...");
                cleanData = fixBadPaste(cleanData);
            }

            // FIX 2: Filter out header row if it got mixed in
            cleanData = cleanData.filter(d => d.id !== 'id' && d.id !== '');

            // FIX 3: THE "MISSING PARENT" SMART FIX
            // We build a map of "Department Name" -> "ID" to help find parents
            const nameToId = {};
            cleanData.forEach(d => {
                if(d.department) nameToId[d.department.trim().toLowerCase()] = d.id;
            });

            log("Verifying Parent IDs...");
            let fixedCount = 0;
            
            cleanData.forEach(d => {
                if (!d.parentId) return; // Root node has no parent

                // If Parent ID is NOT a number (e.g., "Vietnam IT Corp")
                if (isNaN(d.parentId) && d.parentId.length > 3) {
                    const parentName = d.parentId.trim().toLowerCase();
                    if (nameToId[parentName]) {
                        // We found the numeric ID for this name! Swap it.
                        d.parentId = nameToId[parentName];
                        fixedCount++;
                    } else {
                        log(`Warning: Could not find ID for parent name '${d.parentId}'`, true);
                    }
                }
            });

            if(fixedCount > 0) log(`Auto-corrected ${fixedCount} text-based Parent IDs.`);

            try {
                renderChart(cleanData);
                log("Chart rendered successfully!");
            } catch (e) {
                log("Render Error: " + e.message, true);
            }
        }

        // Helper to un-clump single column data
        function fixBadPaste(data) {
            // Detect quote style
            const sample = Object.values(data[0])[0];
            const usesQuotes = sample.includes('"');
            
            return data.map(row => {
                let rawLine = Object.values(row)[0];
                let v;
                if (usesQuotes) {
                    // Split by "," (quote comma quote) and clean quotes
                    v = rawLine.split('","').map(val => val.replace(/^"|"$/g, '').trim());
                } else {
                    v = rawLine.split(',').map(val => val.trim());
                }
                
                // Map array to object keys
                return {
                    id: v[0],
                    parentId: v[1],
                    department: v[2],
                    manager: v[3],
                    rank: v[4],
                    total: v[5],
                    regular: v[6],
                    outsourced: v[7],
                    staff: v[8] || ""
                };
            });
        }

        let chart;

        function renderChart(data) {
            chart = new d3.OrgChart()
                .container('#chart-container')
                .data(data)
                .nodeHeight(d => 180) 
                .nodeWidth(d => 250)
                .childrenMargin(d => 50)
                .compactMarginBetween(d => 20)
                .compactMarginPair(d => 40)
                .nodeContent(function (d) {
                    const staffList = d.data.staff 
                        ? d.data.staff.split(';').map(s => `<div style="font-size:10px; color:#555;">â€¢ ${s.trim()}</div>`).join('') 
                        : '';

                    return `
                        <div class="node-box">
                            <div class="node-header">
                                <strong>${d.data.department}</strong>
                                <div style="font-size:11px; margin-top:2px;">
                                    (Total: ${d.data.total || 0} / Reg: ${d.data.regular || 0})
                                </div>
                            </div>
                            <div class="node-content">
                                <div style="font-weight:bold; margin-bottom:8px;">
                                    ${d.data.manager} 
                                    <span style="color:#666; font-weight:normal">(${d.data.rank})</span>
                                </div>
                                <div style="text-align:left; border-top:1px solid #eee; padding-top:5px; height:80px; overflow-y:auto;">
                                    ${staffList}
                                </div>
                            </div>
                        </div>
                    `;
                })
                .render();
            chart.fit();
        }

        function downloadPdf() {
            if(!chart) return;
            log("Generating PDF...");
            chart.exportImg({
                save: false,
                full: true,
                onLoad: (base64) => {
                    var pdf = new jspdf.jsPDF({
                        orientation: "landscape",
                        unit: "px",
                        format: [chart.svgWidth(), chart.svgHeight()]
                    });
                    pdf.addImage(base64, 'JPEG', 0, 0);
                    pdf.save('Company_Chart.pdf');
                    log("PDF Download complete.");
                }
            });
        }
    </script>
</body>
</html>
